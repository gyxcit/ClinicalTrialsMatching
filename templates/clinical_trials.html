{# templates/clinical_trials.html #}
{% extends "base.html" %}
{% set layout = "app" %}
{% set active_page = "clinical_trials" %}
{% set title = "Clinical Trials ‚Ä¢ TrialMatch" %}

{% block content %}

<style>
  /* Grid like Favorites */
  .trial-grid{
    display:grid;
    grid-template-columns: repeat(auto-fit, minmax(320px, 1fr));
    gap:16px;
    margin-top:16px;
  }

  /* Ensure cards behave like in Favorites */
  .trial-card{
    height:100%;
    display:flex;
    flex-direction:column;
  }
  .trial-actions{ margin-top:auto; }

  /* Profile summary card alignment */
  .profile-summary{
    margin-top:12px;
  }

  /* Controls */
  .trials-controls{
    display:flex;
    align-items:center;
    justify-content:space-between;
    gap:12px;
    margin-top:14px;
    flex-wrap:wrap;
  }
  .trials-controls-left{
    display:flex;
    align-items:center;
    gap:10px;
  }

  /* Pagination align */
  .pagination{
    margin-top:16px;
    display:flex;
    align-items:center;
    justify-content:center;
    gap:12px;
    flex-wrap:wrap;
  }
  .pagination-mid{
    display:flex;
    align-items:center;
    gap:8px;
  }

  /* Empty state */
  .trials-empty{
    margin-top:16px;
  }
  .trials-empty .card{
    padding:28px 18px;
    text-align:center;
  }
  .trials-empty-ic{
    font-size:42px;
    opacity:.6;
    margin-bottom:10px;
  }
  .trials-empty-title{
    font-size:18px;
    font-weight:900;
    margin-bottom:6px;
  }
  .trials-empty-text{
    max-width:560px;
    margin:0 auto;
    color:var(--muted, #64748b);
    font-weight:600;
    line-height:1.5;
  }

  /* Top row */
  .trial-top{
    display:flex;
    align-items:flex-start;
    justify-content:space-between;
    gap:12px;
  }

  /* ‚úÖ PATCH: remove inline style */
  .trial-top-right{
    display:flex;
    gap:10px;
    align-items:center;
  }
</style>

<div class="page-header">
  <div>
    <h1 class="page-title">Clinical Trials</h1>
    <p class="page-subtitle">
      Browse available clinical trials or start matching to find the right ones for you.
    </p>
  </div>

  <div class="header-actions">
    <form method="post" action="{{ url_for('trials.clinical_trials') }}">
      <input type="hidden" name="condition" value="{{ session.get('patient_profile', {}).get('diagnosis', 'Type 2 diabetes') }}">
      <input type="hidden" name="max_studies" value="30">
      <button class="btn btn-outline" type="submit">
        <span class="btn-ic">üóÑÔ∏è</span>
        <span>Load Trials</span>
      </button>
    </form>

    <a class="btn btn-primary" href="{{ url_for('workflow.run_from_profile', num_studies=10) }}">
      <span>Start Matching</span>
      <span class="btn-arrow">‚Üí</span>
    </a>
  </div>
</div>

{% set p = session.get('patient_profile', {}) %}
<div class="profile-summary">
  <div class="profile-left">
    <div class="avatar">
      {{ (p.get('name','J')[:1] if p.get('name') else 'J') | upper }}
    </div>

    <div class="profile-meta">
      <p class="profile-name">{{ p.get('name', 'John Doe') }}</p>
      <p class="profile-detail">
        {{ p.get('diagnosis','Non-Small Cell Lung Cancer') }}
        {% if p.get('stage') %} ‚Ä¢ {{ p.get('stage') }}{% else %} ‚Ä¢ Stage IV{% endif %}
      </p>
    </div>
  </div>

  <a class="btn-soft" href="{{ url_for('patient.patient_profile') }}">Edit Profile</a>
</div>

<!-- ===== Controls: Sort + Pagination info ===== -->
<div class="trials-controls">
  <div class="trials-controls-left">
    <label class="select-label" for="sortSelect">Sort by</label>
    <select id="sortSelect" class="select">
      <option value="updated_desc">Most Recent</option>
      <option value="title_asc">Title (A ‚Üí Z)</option>
      <option value="phase_desc">Phase (High ‚Üí Low)</option>
      <option value="recruiting_first">Recruiting First</option>
    </select>
  </div>

  <div class="trials-controls-right">
    <span id="showingText" class="muted"></span>
  </div>
</div>

{% if not trials or trials|length == 0 %}

  <div class="trials-empty">
    <div class="card">
      <div class="trials-empty-ic">üóÇÔ∏è</div>
      <div class="trials-empty-title">No trials loaded yet</div>
      <div class="trials-empty-text">
        Click <strong>Load Trials</strong> to fetch studies related to your patient profile diagnosis,
        then sort, browse, and save your favorites.
      </div>
    </div>
  </div>

{% else %}

  <!-- ===== Trials list ===== -->
  <div id="trialList" class="trial-grid">
    {% for t in trials %}
      {% set ps = t.get("protocolSection", {}) %}
      {% set idm = ps.get("identificationModule", {}) %}
      {% set st = ps.get("statusModule", {}) %}
      {% set dm = ps.get("designModule", {}) %}
      {% set sm = ps.get("sponsorCollaboratorsModule", {}) %}
      {% set cm = ps.get("conditionsModule", {}) %}

      {% set title_ = idm.get("briefTitle") or "Untitled study" %}
      {% set nct = idm.get("nctId") or "" %}
      {% set phase = (dm.get("phases", []) | first) if dm.get("phases") else "" %}
      {% set overall_status = st.get("overallStatus") or "" %}
      {% set updated = st.get("lastUpdateSubmitDate") or st.get("studyFirstSubmitDate") or "" %}
      {% set sponsor = (sm.get("leadSponsor", {}) or {}).get("name") or "" %}
      {% set condition = (cm.get("conditions", []) | first) if cm.get("conditions") else "" %}

      <article
        class="trial-card card"
        data-title="{{ title_|lower }}"
        data-phase="{{ phase }}"
        data-status="{{ overall_status }}"
        data-updated="{{ updated }}"
      >
        <div class="trial-top">
          <div class="trial-badges">
            {% if phase %}<span class="badge badge-phase">{{ phase }}</span>{% endif %}
            {% if overall_status %}<span class="badge badge-status">{{ overall_status }}</span>{% endif %}
          </div>

          {% if nct %}
            <div class="trial-top-right">
              <a class="trial-nct muted" target="_blank" rel="noopener"
                href="https://clinicaltrials.gov/study/{{ nct }}">
                {{ nct }}
              </a>

              <button
                type="button"
                class="heart {{ 'is-fav' if favorites and (nct in favorites) else '' }}"
                data-nct="{{ nct }}"
                aria-label="Toggle favorite"
                aria-pressed="{{ 'true' if favorites and (nct in favorites) else 'false' }}"
                title="{{ 'Remove from Favorites' if favorites and (nct in favorites) else 'Add to Favorites' }}"
              >
                <span class="heart-ic">{{ '‚ù§Ô∏è' if favorites and (nct in favorites) else 'ü§ç' }}</span>
              </button>
            </div>
          {% endif %}
        </div>

        <h3 class="trial-title">{{ title_ }}</h3>

        <div class="trial-meta">
          {% if condition %}<div class="trial-meta-row">üß™ <span>{{ condition }}</span></div>{% endif %}
          {% if sponsor %}<div class="trial-meta-row">üè• <span>{{ sponsor }}</span></div>{% endif %}
          {% if updated %}<div class="trial-meta-row">üïí <span>Updated: {{ updated }}</span></div>{% endif %}
        </div>

        <div class="trial-actions">
          {% if nct %}
            <a class="btn btn-outline btn-sm w-full" target="_blank" rel="noopener"
              href="https://clinicaltrials.gov/study/{{ nct }}">
              View Details ‚Üó
            </a>
          {% else %}
            <button class="btn btn-outline btn-sm w-full" disabled>View Details</button>
          {% endif %}
        </div>
      </article>
    {% endfor %}
  </div>

  <!-- ===== Pagination ===== -->
  <div class="pagination">
    <button class="btn btn-outline btn-sm" id="prevBtn" type="button">‚Üê Prev</button>
    <div class="pagination-mid">
      <span class="muted">Page</span>
      <span id="pageText" class="page-pill">1</span>
      <span class="muted">/</span>
      <span id="pageTotal" class="muted">1</span>
    </div>
    <button class="btn btn-outline btn-sm" id="nextBtn" type="button">Next ‚Üí</button>
  </div>

{% endif %}

<script>
  // ===== Sorting + Pagination (10 per page) =====
  const PAGE_SIZE = 10;

  const listEl = document.getElementById("trialList");
  const sortSelect = document.getElementById("sortSelect");
  const showingText = document.getElementById("showingText");
  const prevBtn = document.getElementById("prevBtn");
  const nextBtn = document.getElementById("nextBtn");
  const pageText = document.getElementById("pageText");
  const pageTotal = document.getElementById("pageTotal");

  const cards = listEl ? Array.from(listEl.querySelectorAll(".trial-card")) : [];
  let currentPage = 1;
  let working = [...cards];

  // ‚úÖ PATCH: robust phase parsing (PHASE3, Phase 3, phase_2, etc.)
  function parsePhase(phaseStr){
    if(!phaseStr) return 0;
    const s = String(phaseStr).toLowerCase();
    const m = s.match(/phase\D*([0-4])/);
    return m ? parseInt(m[1], 10) : 0;
  }

  function statusWeight(status){
    const s = (status || "").toLowerCase().trim();
    if (s === "recruiting") return 0;
    if (s.includes("enrolling")) return 1;
    if (s.includes("active") && s.includes("not recruiting")) return 2;
    if (s.includes("not yet recruiting")) return 3;
    if (s.includes("completed")) return 4;
    return 9;
  }

  function parseDate(d){
    if(!d) return 0;
    const ts = Date.parse(d);
    return isNaN(ts) ? 0 : ts;
  }

  function applySort(){
    if(!sortSelect || !listEl) return;

    const mode = sortSelect.value;

    working.sort((a, b) => {
      const ta = a.dataset.title || "";
      const tb = b.dataset.title || "";
      const pa = parsePhase(a.dataset.phase || "");
      const pb = parsePhase(b.dataset.phase || "");
      const sa = statusWeight(a.dataset.status || "");
      const sb = statusWeight(b.dataset.status || "");
      const da = parseDate(a.dataset.updated || "");
      const db = parseDate(b.dataset.updated || "");

      switch(mode){
        case "title_asc": return ta.localeCompare(tb);
        case "phase_desc": return pb - pa;
        case "recruiting_first": return sa - sb;
        case "updated_desc":
        default: return db - da;
      }
    });

    currentPage = 1;
    renderPage();
  }

  function renderPage(){
    if(!listEl) return;

    listEl.innerHTML = "";

    const total = working.length;
    const totalPages = Math.max(1, Math.ceil(total / PAGE_SIZE));

    currentPage = Math.min(Math.max(1, currentPage), totalPages);

    const startIdx = (currentPage - 1) * PAGE_SIZE;
    const endIdx = Math.min(startIdx + PAGE_SIZE, total);
    const slice = working.slice(startIdx, endIdx);

    slice.forEach(card => listEl.appendChild(card));

    if(pageText) pageText.textContent = String(currentPage);
    if(pageTotal) pageTotal.textContent = String(totalPages);

    if(prevBtn) prevBtn.disabled = (currentPage <= 1);
    if(nextBtn) nextBtn.disabled = (currentPage >= totalPages);

    if(showingText){
      showingText.textContent = total === 0
        ? "No trials loaded yet."
        : `Showing ${startIdx + 1}‚Äì${endIdx} of ${total}`;
    }
  }

  // ===== Favorites AJAX =====
  async function toggleFavorite(btn){
    const nct = btn.dataset.nct;
    if(!nct) return;

    btn.disabled = true;
    try{
      const res = await fetch("/api/favorites/toggle", {
        method: "POST",
        headers: {"Content-Type":"application/json"},
        body: JSON.stringify({ nct })
      });

      const data = await res.json();
      if(!data.ok) throw new Error(data.error || "Request failed");

      const isFav = data.is_favorite;
      btn.classList.toggle("is-fav", isFav);
      btn.setAttribute("aria-pressed", isFav ? "true" : "false");
      btn.title = isFav ? "Remove from Favorites" : "Add to Favorites";

      const ic = btn.querySelector(".heart-ic");
      if(ic) ic.textContent = isFav ? "‚ù§Ô∏è" : "ü§ç";

    } catch(err){
      console.error(err);
      alert("Impossible de mettre √† jour les favoris. R√©essaie.");
    } finally{
      btn.disabled = false;
    }
  }

  document.addEventListener("click", (e) => {
    const btn = e.target.closest(".heart");
    if(!btn) return;
    toggleFavorite(btn);
  });

  if(sortSelect) sortSelect.addEventListener("change", applySort);
  if(prevBtn) prevBtn.addEventListener("click", () => { currentPage--; renderPage(); });
  if(nextBtn) nextBtn.addEventListener("click", () => { currentPage++; renderPage(); });

  applySort();
</script>

{% endblock %}
