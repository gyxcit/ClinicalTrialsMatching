{% extends "base.html" %}
{% set layout = "app" %}
{% set active_page = "favorites" %}

{% block content %}

<div class="page-header">
  <div>
    <h1 class="page-title">Favorites</h1>
    <p class="page-subtitle">Clinical trials you've saved for later review.</p>
  </div>
  {% set count_ids = (favorites|length) if favorites else 0 %}
  {% set count_cards = (fav_trials|length) if fav_trials else 0 %}

  <div class="header-actions">
    <span class="fav-count">{{ count_ids }} saved trial{{ '' if count_ids == 1 else 's' }}</span>
  </div>

{% if count_ids == 0 or count_cards == 0 %}
  <div class="fav-empty">
    <div class="fav-empty-ic">â™¡</div>
    <div class="fav-empty-title">No Favorites Yet</div>
    <div class="fav-empty-text">
      Browse clinical trials and click the heart icon to save trials you're interested in.
    </div>
  </div>
{% else %}

  <div class="trial-list">
    {% for t in fav_trials %}
      {% set ps = t.get("protocolSection", {}) %}
      {% set idm = ps.get("identificationModule", {}) %}
      {% set st = ps.get("statusModule", {}) %}
      {% set dm = ps.get("designModule", {}) %}
      {% set sm = ps.get("sponsorCollaboratorsModule", {}) %}
      {% set cm = ps.get("conditionsModule", {}) %}

      {% set title = idm.get("briefTitle") or "Untitled study" %}
      {% set nct = idm.get("nctId") or "" %}
      {% set phase = (dm.get("phases", []) | first) if dm.get("phases") else "" %}
      {% set overall_status = st.get("overallStatus") or "" %}
      {% set updated = st.get("lastUpdateSubmitDate") or st.get("studyFirstSubmitDate") or "" %}
      {% set sponsor = (sm.get("leadSponsor", {}) or {}).get("name") or "" %}
      {% set condition = (cm.get("conditions", []) | first) if cm.get("conditions") else "" %}

      <article class="trial-card"
        data-title="{{ title|lower }}"
        data-phase="{{ phase }}"
        data-status="{{ overall_status }}"
        data-updated="{{ updated }}"
      >
        <div class="trial-top">
          <div class="trial-badges">
            {% if phase %}<span class="badge badge-phase">{{ phase }}</span>{% endif %}
            {% if overall_status %}<span class="badge badge-status">{{ overall_status }}</span>{% endif %}
          </div>

          {% if nct %}
            <button
              type="button"
              class="heart is-fav"
              data-nct="{{ nct }}"
              aria-label="Toggle favorite"
              aria-pressed="true"
              title="Remove from Favorites"
            >
              <span class="heart-ic">â¤ï¸</span>
            </button>
          {% endif %}
        </div>

        <h3 class="trial-title">{{ title }}</h3>

        <div class="trial-meta">
          {% if condition %}<div class="trial-meta-row">ğŸ§ª <span>{{ condition }}</span></div>{% endif %}
          {% if sponsor %}<div class="trial-meta-row">ğŸ¥ <span>{{ sponsor }}</span></div>{% endif %}
          {% if updated %}<div class="trial-meta-row">ğŸ•’ <span>Updated: {{ updated }}</span></div>{% endif %}
          {% if nct %}
            <div class="trial-meta-row">ğŸ”— <a class="muted" target="_blank" rel="noopener" href="https://clinicaltrials.gov/study/{{ nct }}">{{ nct }}</a></div>
          {% endif %}
        </div>

        <div class="trial-actions">
          {% if nct %}
            <a class="btn btn-outline btn-sm w-full" target="_blank" rel="noopener"
              href="https://clinicaltrials.gov/study/{{ nct }}">
              View Details â†—
            </a>
          {% else %}
            <button class="btn btn-outline btn-sm w-full" disabled>View Details</button>
          {% endif %}
        </div>
      </article>
    {% endfor %}
  </div>

{% endif %}

<script>
  async function toggleFavorite(btn){
    const nct = btn.dataset.nct;
    if(!nct) return;

    btn.disabled = true;
    try{
      const res = await fetch("/api/favorites/toggle", {
        method: "POST",
        headers: {"Content-Type":"application/json"},
        body: JSON.stringify({ nct })
      });

      const data = await res.json();
      if(!data.ok) throw new Error(data.error || "Request failed");

      // Si on retire un favori depuis la page Favorites => on enlÃ¨ve la card (UX clean)
      if(!data.is_favorite){
        const card = btn.closest(".trial-card");
        if(card) card.remove();

        // update compteur
        const el = document.querySelector(".fav-count");
        if(el) el.textContent = `${data.count} saved trial${data.count === 1 ? "" : "s"}`;

        // si plus rien => reload simple pour afficher empty state
        if(data.count === 0){
          window.location.reload();
        }
      }
    } catch(err){
      console.error(err);
      alert("Impossible de mettre Ã  jour les favoris. RÃ©essaie.");
    } finally{
      btn.disabled = false;
    }
  }

  document.addEventListener("click", (e) => {
    const btn = e.target.closest(".heart");
    if(!btn) return;
    toggleFavorite(btn);
  });
</script>

{% endblock %}
