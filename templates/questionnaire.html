{# templates/questionnaire.html #}
{% extends "base.html" %}
{% set layout = "app" %}
{% set active_page = "matching" %}
{% set title = "Questionnaire ‚Ä¢ TrialMatch" %}

{% block content %}

<script>
  const URLS = {
    currentTrial: "{{ url_for('questionnaire.get_current_trial') }}",
    submitAnswer: "{{ url_for('questionnaire.submit_answer') }}",
    getResults: "{{ url_for('results.get_results') }}",
    explain: "{{ url_for('results.explain_result') }}",
    reformulate: "{{ url_for('questionnaire.reformulate_question') }}",
    favoritesPage: "{{ url_for('favorites.favorites') }}",
    favoriteToggle: "{{ url_for('favorites.api_toggle_favorite') }}",
  };

  // Session favorites snapshot
  const SESSION_FAVORITES = {{ (session.get("favorites", []) or []) | tojson }};
</script>

<div class="page-header">
  <div>
    <h1 class="page-title">Trial Matching</h1>
    <p class="page-subtitle">Answer a few questions to estimate your eligibility.</p>
  </div>
</div>

<!-- WELCOME -->
<section id="welcome-screen" class="card">
  <div class="card-h">
    <h2 class="card-title">Start your assessment</h2>

    {% if session.get('user_language_name') %}
      <div class="detected-lang">
        üåç <span>Detected Language:</span>
        <strong>{{ session.get('user_language_name') }}</strong>
      </div>
    {% endif %}

    <p class="card-sub" style="margin-top:10px;">
      We‚Äôll assess eligibility across <strong>{{ total_trials }}</strong> clinical trials.
      Answer <strong>Yes</strong>, <strong>No</strong>, or <strong>I don‚Äôt know</strong>.
    </p>
  </div>

  <div class="actions-right">
    <button class="btn btn-primary" onclick="startQuestionnaire()" type="button">
      Start Assessment <span class="btn-arrow">‚Üí</span>
    </button>
  </div>
</section>

<!-- QUESTIONNAIRE -->
<section id="questionnaire-screen" class="stack-24 hidden">

  <!-- Trial header card -->
  <div class="card">
    <div class="qm-top">
      <div class="qm-title-wrap">
        <h2 class="qm-trial-title" id="trial-title">Loading...</h2>

        <div class="qm-meta">
          <span class="badge badge-status">Trial ID: <strong id="trial-id">-</strong></span>
          <span class="badge badge-status">
            Progress: <strong><span id="trial-number">-</span></strong> /
            <strong><span id="total-trials">-</span></strong>
          </span>
        </div>
      </div>

      <div class="qm-progress">
        <div class="progress-bar">
          <div class="progress-fill" id="progress"></div>
        </div>
      </div>
    </div>

    <div id="notification-area"></div>
  </div>

  <!-- Question card -->
  <div class="card">
    <div class="qm-qhead">
      <span class="badge" id="question-type">-</span>

      <button class="btn btn-outline btn-sm" onclick="reformulateQuestion()" id="reformulate-btn" type="button">
        üîÑ Reformulate
      </button>
    </div>

    <div class="qm-question" id="question-text">Loading question...</div>

    <div class="qm-actions">
      <button class="btn qm-btn qm-btn-yes" onclick="submitAnswer(true)" type="button">Yes</button>
      <button class="btn qm-btn qm-btn-unsure" onclick="submitAnswer('unsure')" type="button">ü§∑‚Äç‚ôÇÔ∏è I don‚Äôt know</button>
      <button class="btn qm-btn qm-btn-no" onclick="submitAnswer(false)" type="button">No</button>
    </div>
  </div>

</section>

<!-- RESULTS -->
<section id="results-screen" class="stack-24 hidden">

  <div class="page-header" style="margin-bottom:0;">
    <div>
      <h1 class="page-title">Results</h1>
      <p class="page-subtitle">Your eligibility assessment is complete</p>
    </div>
    <div class="header-actions">
      <button class="btn btn-primary" onclick="location.reload()" type="button">
        New Assessment <span class="btn-arrow">‚Üí</span>
      </button>
    </div>
  </div>

  <!-- Summary cards -->
  <div class="qm-stats">
    <div class="qm-stat qm-stat--success">
      <div class="qm-stat-num" id="eligible-count">0</div>
      <div class="qm-stat-label">Strong Matches</div>
    </div>
    <div class="qm-stat qm-stat--warn">
      <div class="qm-stat-num" id="partial-count">0</div>
      <div class="qm-stat-label">Potential Matches</div>
    </div>
    <div class="qm-stat">
      <div class="qm-stat-num" id="total-assessed">0</div>
      <div class="qm-stat-label">Total Analyzed</div>
    </div>
  </div>

  <div class="card">
    <div class="card-h">
      <h2 class="card-title">Top Recommendations</h2>
      <p class="card-sub">Trials ordered by match score.</p>
    </div>

    <div id="results-list" class="qm-results"></div>
  </div>

</section>

<script>
  let currentQuestion = null;
  let currentTrial = null;
  let originalQuestion = null;

  // Explanation cache (avoid regenerating on show/hide)
  const EXPLANATION_CACHE = {};

  // Favorites Set (session truth)
  const FAVORITES = new Set(Array.isArray(SESSION_FAVORITES) ? SESSION_FAVORITES : []);

  const el = (id) => document.getElementById(id);
  const setText = (id, value) => { const x = el(id); if (x) x.textContent = value; };

  const show = (id) => { const x = el(id); if (x) x.classList.remove("hidden"); };
  const hide = (id) => { const x = el(id); if (x) x.classList.add("hidden"); };

  function showNotification(message, type){
    const area = el("notification-area");
    if (!area) return;
    const cls =
      type === "excluded" ? "notice notice-danger" :
      type === "completed" ? "notice notice-info" :
      "notice notice-info";
    area.innerHTML = `<div class="${cls}">${message}</div>`;
  }
  function clearNotification(){
    const area = el("notification-area");
    if (area) area.innerHTML = "";
  }

  function updateProgress(current, total){
    const pct = total ? (current / total) * 100 : 0;
    const bar = el("progress");
    if (bar) bar.style.width = pct + "%";
  }

  async function fetchJson(url, options){
    const res = await fetch(url, options);
    let data;
    try { data = await res.json(); }
    catch { throw new Error(`Server returned invalid JSON (${res.status})`); }
    if (!res.ok || (data && data.error)) {
      throw new Error((data && data.error) ? data.error : `Request failed (${res.status})`);
    }
    return data;
  }

  async function startQuestionnaire(){
    hide("welcome-screen");
    show("questionnaire-screen");
    await loadNextQuestion();
  }

  async function loadNextQuestion(){
    try{
      const data = await fetchJson(URLS.currentTrial);

      if (data.completed){
        showResults(data.results || []);
        return;
      }

      currentTrial = data.trial_info;
      currentQuestion = data.current_question;
      originalQuestion = currentQuestion?.question || null;

      setText("trial-title", currentTrial?.title || "Trial");
      setText("trial-id", currentTrial?.nct_id || "-");
      setText("trial-number", String(currentTrial?.trial_number || "-"));
      setText("total-trials", String(currentTrial?.total_trials || "-"));

      setText("question-text", currentQuestion?.question || "Question");

      const qt = el("question-type");
      if (qt){
        const isExcl = currentQuestion?.type === "exclusion";
        qt.textContent = isExcl ? "‚õî Exclusion Criteria" : "‚úÖ Inclusion Criteria";
        qt.className = "badge " + (isExcl ? "badge-danger" : "badge-success");
      }

      updateProgress(currentTrial?.trial_number || 0, currentTrial?.total_trials || 1);

    } catch(err){
      console.error(err);
      showNotification(`‚ùå ${err.message}`, "excluded");
    }
  }

  async function reformulateQuestion(){
    if (!originalQuestion || !currentTrial) return;

    const btn = el("reformulate-btn");
    const questionEl = el("question-text");
    if (!btn || !questionEl) return;

    btn.disabled = true;
    btn.textContent = "‚è≥ Reformulating‚Ä¶";

    try{
      const data = await fetchJson(URLS.reformulate, {
        method: "POST",
        headers: { "Content-Type":"application/json" },
        body: JSON.stringify({
          question: originalQuestion,
          context: { trial_title: currentTrial.title, nct_id: currentTrial.nct_id }
        })
      });

      questionEl.textContent = data.simplified_question || originalQuestion;
      showNotification("‚ú® Question simplified!", "completed");
      setTimeout(clearNotification, 1200);

    } catch(err){
      console.error(err);
      showNotification(`‚ùå ${err.message}`, "excluded");
      setTimeout(clearNotification, 2000);
    } finally{
      btn.disabled = false;
      btn.textContent = "üîÑ Reformulate";
    }
  }

  async function submitAnswer(answer){
    if (!currentTrial || !currentQuestion) return;

    try{
      const data = await fetchJson(URLS.submitAnswer, {
        method:"POST",
        headers:{ "Content-Type":"application/json" },
        body: JSON.stringify({
          question_id: currentQuestion.question_id,
          answer,
          nct_id: currentTrial.nct_id,
          question_type: currentQuestion.type
        })
      });

      if (data.excluded){
        showNotification("‚ùå You are excluded from this trial. Moving to the next trial‚Ä¶", "excluded");
        setTimeout(() => { clearNotification(); loadNextQuestion(); }, 1400);
        return;
      }

      if (data.trial_completed && data.all_completed){
        const rd = await fetchJson(URLS.getResults);
        showResults(rd.results || []);
        return;
      }

      if (data.trial_completed && data.move_to_next){
        showNotification(`‚úì Trial complete ‚Ä¢ Match ${data.inclusion_percentage}% (${data.inclusion_score}/${data.total_inclusion_questions})`, "completed");
        setTimeout(() => { clearNotification(); loadNextQuestion(); }, 1400);
        return;
      }

      currentQuestion = data.current_question;
      currentTrial = data.trial_info || currentTrial;
      originalQuestion = currentQuestion?.question || null;

      setText("question-text", currentQuestion?.question || "Question");

      const qt = el("question-type");
      if (qt){
        const isExcl = currentQuestion?.type === "exclusion";
        qt.textContent = isExcl ? "‚õî Exclusion Criteria" : "‚úÖ Inclusion Criteria";
        qt.className = "badge " + (isExcl ? "badge-danger" : "badge-success");
      }

    } catch(err){
      console.error(err);
      showNotification(`‚ùå ${err.message}`, "excluded");
    }
  }

  // External trial link (clinicaltrials.gov)
  function trialLink(nctId){
    return `https://clinicaltrials.gov/study/${nctId}`;
  }

  // Favorites (SESSION via AJAX)
  function isFavorite(nctId){
    return FAVORITES.has(nctId);
  }

  function applyFavoriteUI(nctId){
    const btn = document.querySelector(`.qm-fav-btn[data-nct="${nctId}"]`);
    if (!btn) return;

    const heart = btn.querySelector(".qm-heart");
    const label = btn.querySelector(".qm-fav-label");
    const on = isFavorite(nctId);

    if (heart) heart.textContent = on ? "‚ô•" : "‚ô°";
    if (label) label.textContent = on ? "Saved" : "Save";

    btn.classList.toggle("qm-fav-on", on);
  }

  function initFavoritesUI(){
    document.querySelectorAll(".qm-fav-btn[data-nct]").forEach(btn => {
      const nct = btn.getAttribute("data-nct");
      if (nct) applyFavoriteUI(nct);
    });
  }

  async function toggleFavorite(evt, nctId){
    const btn = evt.currentTarget || evt.target;
    if (!nctId || !btn) return;

    btn.disabled = true;

    try{
      const data = await fetchJson(URLS.favoriteToggle, {
        method:"POST",
        headers:{ "Content-Type":"application/json" },
        body: JSON.stringify({ nct: nctId })
      });

      if (data.is_favorite) FAVORITES.add(nctId);
      else FAVORITES.delete(nctId);

      applyFavoriteUI(nctId);

    } catch(err){
      console.error(err);
      showNotification(`‚ùå ${err.message}`, "excluded");
      setTimeout(clearNotification, 1800);
    } finally{
      btn.disabled = false;
    }
  }

  // Result helpers
  function summarizeMatch(r){
    const pct = Math.round(r.inclusion_percentage || 0);
    if (r.eligible) return "You appear to be a strong match for this trial based on your answers.";
    if (pct >= 50) return "You may be a potential match, but some criteria may be missing or not met.";
    if (pct > 0) return "This trial seems less aligned with your profile based on the current answers.";
    return "This trial does not appear to match your profile based on the current answers.";
  }

  function extractPhase(title=""){
    const m = title.match(/\bPhase\s*([0-4]|I{1,3}V?)\b/i);
    if (!m) return null;
    return `Phase ${String(m[1]).toUpperCase()}`;
  }

  function extractBiomarkerBadges(text=""){
    const biomarkers = ["PD-L1","EGFR","ALK","ROS1","HER2","KRAS","BRAF","MET","RET","NTRK","BRCA","MSI","TMB"];
    const found = [];
    for (const b of biomarkers){
      const re = new RegExp(`\\b${b.replace("-","\\-")}\\b`, "i");
      if (re.test(text)) found.push(b);
      if (found.length >= 2) break;
    }
    return found;
  }

  function extractNaiveBadge(text=""){
    if (/\bna[i√Ø]ve\b/i.test(text) || /\btreatment[-\s]?na[i√Ø]ve\b/i.test(text) || /\bTKI[-\s]?na[i√Ø]ve\b/i.test(text)){
      return "Treatment Naive";
    }
    return null;
  }

  function buildBadges(r){
    const title = r.title || "";
    const badges = [];

    const pct = Math.round(r.inclusion_percentage || 0);
    if (r.eligible) badges.push({label:"Strong Match", cls:"badge badge-success"});
    else if (pct > 0) badges.push({label:"Potential Match", cls:"badge badge-warning"});
    else badges.push({label:"Not Eligible", cls:"badge badge-danger"});

    const phase = extractPhase(title);
    if (phase) badges.push({label:phase, cls:"badge badge-status"});

    const bio = extractBiomarkerBadges(title);
    for (const b of bio){
      if (badges.length >= 3) break;
      badges.push({label:b, cls:"badge badge-status"});
    }

    const naive = extractNaiveBadge(title);
    if (naive && badges.length < 3){
      badges.push({label:naive, cls:"badge badge-status"});
    }

    return badges;
  }

  // logic:
  // - If met == 0 => do NOT show "You meet these requirements"
  // - If missing == 0 => do NOT show "Information needed"
  function metMissingFromScores(r){
    const met = Number(r.inclusion_score || 0);
    const total = Number(r.total_inclusion_questions || 0);
    const missing = Math.max(0, total - met);

    let metText = null;
    let missingText = null;

    if (met > 0){
      metText = total > 0
        ? `Meets <strong>${met}</strong> of <strong>${total}</strong> inclusion criteria based on your answers.`
        : `Some inclusion criteria were evaluated based on your answers.`;
    }

    if (missing > 0){
      // (you previously asked to remove this line entirely at one point;
      // leaving it here because your current file includes it and
      // your latest request was only about removing "Next steps".
      // If you want to remove it globally again, tell me and I‚Äôll delete it.)
      missingText = `Missing/uncertain: <strong>${missing}</strong> criteria. Additional information may be needed.`;
    }

    return { metText, missingText };
  }

  function renderRing(elRing, pct){
    if (!elRing) return;
    const cl =
      pct >= 75 ? "var(--success)" :
      pct >= 40 ? "#F59E0B" :
      "#EF4444";
    elRing.style.background = `conic-gradient(${cl} ${pct}%, rgba(20,30,40,.10) 0)`;
  }

  function eligibilityBorderClass(r){
    const pct = Math.round(r.inclusion_percentage || 0);
    if (r.eligible) return "card--eligible";
    if (pct > 0) return "card--partial";
    return "card--not-eligible";
  }

  function showResults(results){
    hide("questionnaire-screen");
    hide("welcome-screen");
    show("results-screen");

    const eligible = results.filter(r => r.eligible);
    const partial = results.filter(r => !r.eligible && (r.inclusion_percentage || 0) > 0);

    setText("total-assessed", String(results.length));
    setText("eligible-count", String(eligible.length));
    setText("partial-count", String(partial.length));

    const list = el("results-list");
    if (!list) return;
    list.innerHTML = "";

    results.forEach((r, idx) => {
      const pct = Math.round(r.inclusion_percentage || 0);
      const badges = buildBadges(r);
      const { metText, missingText } = metMissingFromScores(r);
      const borderCls = eligibilityBorderClass(r);

      const item = document.createElement("div");
      item.className = `qm-result qm-result--card ${borderCls}`;

      item.innerHTML = `
        <div class="qm-ring" data-pct="${pct}">
          <div class="qm-ring-inner">${pct}%</div>
        </div>

        <div class="qm-result-body">
          <div class="qm-result-top">
            <div class="qm-result-title">${idx+1}. ${r.nct_id}</div>
            <div class="qm-badges">
              ${badges.map(b => `<span class="${b.cls}">${b.label}</span>`).join("")}
            </div>
          </div>

          <div class="qm-result-sub">${r.title || ""}</div>

          <div class="qm-summary">${summarizeMatch(r)}</div>

          <div class="qm-reqs">
            ${
              metText
                ? `
                  <div class="qm-req qm-req--ok">
                    <div class="qm-req-title">‚úÖ You meet these requirements</div>
                    <div class="qm-req-text">${metText}</div>
                  </div>
                `
                : ""
            }

            ${
              missingText
                ? `
                  <div class="qm-req qm-req--miss">
                    <div class="qm-req-title">‚ö†Ô∏è Information needed</div>
                    <div class="qm-req-text">${missingText}</div>
                  </div>
                `
                : ""
            }
          </div>

          <div class="qm-result-actions">
            <a class="btn btn-outline btn-sm" href="${trialLink(r.nct_id)}" target="_blank" rel="noopener">
              View Trial ‚Üí
            </a>

            <button class="btn btn-outline btn-sm qm-fav-btn"
                    type="button"
                    data-nct="${r.nct_id}"
                    onclick="toggleFavorite(event, '${r.nct_id}')">
              <span class="qm-heart">‚ô°</span>
              <span class="qm-fav-label">Save</span>
            </button>

            <button class="btn btn-outline btn-sm" onclick="explainResult(event, '${r.nct_id}')" type="button">
              ü§ñ Explain
            </button>
          </div>

          <div id="explanation-${r.nct_id}" class="qm-explain hidden"></div>
        </div>
      `;

      list.appendChild(item);
      renderRing(item.querySelector(".qm-ring"), pct);
      applyFavoriteUI(r.nct_id);
    });

    initFavoritesUI();
  }

  async function explainResult(evt, nctId){
    const box = el(`explanation-${nctId}`);
    const btn = evt.target;
    if (!box) return;

    // If already visible -> hide without clearing
    if (!box.classList.contains("hidden")){
      box.classList.add("hidden");
      btn.textContent = "ü§ñ Explain";
      return;
    }

    // If cached -> show instantly
    if (EXPLANATION_CACHE[nctId]){
      box.innerHTML = EXPLANATION_CACHE[nctId];
      box.classList.remove("hidden");
      btn.textContent = "ü§ñ Hide";
      return;
    }

    btn.disabled = true;
    btn.textContent = "‚è≥ Generating‚Ä¶";

    box.classList.remove("hidden");
    box.innerHTML = `<div class="notice notice-info">Analyzing your responses‚Ä¶</div>`;

    try{
      const data = await fetchJson(URLS.explain, {
        method:"POST",
        headers:{ "Content-Type":"application/json" },
        body: JSON.stringify({ nct_id: nctId })
      });

      const html = `
        <div class="qm-explain-card">
          <div class="qm-explain-title">üìã Explanation</div>
          <div class="qm-explain-text">${(data.explanation || "").replaceAll("\n","<br>")}</div>
        </div>
      `;

      EXPLANATION_CACHE[nctId] = html;
      box.innerHTML = html;
      btn.textContent = "ü§ñ Hide";

    } catch(err){
      console.error(err);
      box.innerHTML = `<div class="notice notice-danger">‚ùå ${err.message}</div>`;
      btn.textContent = "ü§ñ Explain";
    } finally{
      btn.disabled = false;
    }
  }
</script>

{% endblock %}
