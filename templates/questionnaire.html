<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Clinical Trial Eligibility Questionnaire</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 20px;
        }

        .container {
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            max-width: 800px;
            width: 100%;
            padding: 40px;
        }

        h1 {
            color: #333;
            margin-bottom: 10px;
            font-size: 2em;
        }

        .subtitle {
            color: #666;
            margin-bottom: 30px;
        }

        .progress-bar {
            background: #e0e0e0;
            height: 10px;
            border-radius: 5px;
            margin-bottom: 20px;
            overflow: hidden;
        }

        .progress-fill {
            background: linear-gradient(90deg, #667eea 0%, #764ba2 100%);
            height: 100%;
            width: 0%;
            transition: width 0.3s ease;
        }

        .trial-info {
            background: #f5f5f5;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 30px;
        }

        .trial-info h2 {
            color: #667eea;
            margin-bottom: 10px;
            font-size: 1.2em;
        }

        .trial-info p {
            color: #666;
            line-height: 1.6;
        }

        .question-container {
            margin-bottom: 30px;
        }

        .question-type {
            display: inline-block;
            padding: 5px 15px;
            border-radius: 20px;
            font-size: 0.9em;
            font-weight: bold;
            margin-bottom: 15px;
        }

        .question-type.exclusion {
            background: #ffebee;
            color: #c62828;
        }

        .question-type.inclusion {
            background: #e8f5e9;
            color: #2e7d32;
        }

        .question {
            font-size: 1.3em;
            color: #333;
            margin-bottom: 25px;
            line-height: 1.5;
        }

        .button-group {
            display: flex;
            gap: 20px;
            justify-content: center;
        }

        button {
            padding: 15px 40px;
            font-size: 1.1em;
            border: none;
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-weight: bold;
        }

        .btn-yes {
            background: #4caf50;
            color: white;
        }

        .btn-yes:hover {
            background: #45a049;
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(76, 175, 80, 0.4);
        }

        .btn-no {
            background: #f44336;
            color: white;
        }

        .btn-no:hover {
            background: #da190b;
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(244, 67, 54, 0.4);
        }

        .btn-start {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px 50px;
            font-size: 1.2em;
        }

        .btn-start:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 30px rgba(102, 126, 234, 0.4);
        }

        .btn-explain {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 10px 20px;
            font-size: 0.9em;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            margin-top: 15px;
            transition: all 0.3s ease;
        }

        .btn-explain:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }

        .btn-explain:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }

        .results {
            margin-top: 30px;
        }

        .result-item {
            background: #f5f5f5;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 15px;
            border-left: 5px solid #ccc;
        }

        .result-item.eligible {
            border-left-color: #4caf50;
            background: #e8f5e9;
        }

        .result-item.partial {
            border-left-color: #ff9800;
            background: #fff3e0;
        }

        .result-item.not-eligible {
            border-left-color: #f44336;
            background: #ffebee;
        }

        .result-item h3 {
            margin-bottom: 10px;
            color: #333;
        }

        .result-item p {
            color: #666;
            margin: 5px 0;
        }

        .percentage-badge {
            display: inline-block;
            padding: 5px 15px;
            border-radius: 20px;
            font-weight: bold;
            margin-left: 10px;
            font-size: 0.9em;
        }

        .percentage-100 {
            background: #4caf50;
            color: white;
        }

        .percentage-high {
            background: #8bc34a;
            color: white;
        }

        .percentage-medium {
            background: #ff9800;
            color: white;
        }

        .percentage-low {
            background: #f44336;
            color: white;
        }

        .loading {
            text-align: center;
            color: #667eea;
            font-size: 1.2em;
            margin: 20px 0;
        }

        .hidden {
            display: none;
        }

        .notification {
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 20px;
            animation: slideIn 0.3s ease;
        }

        .notification.excluded {
            background: #ffebee;
            color: #c62828;
            border-left: 5px solid #c62828;
        }

        .notification.completed {
            background: #e3f2fd;
            color: #1565c0;
            border-left: 5px solid #1565c0;
        }

        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateY(-10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .score-display {
            background: #e3f2fd;
            padding: 15px;
            border-radius: 10px;
            margin: 10px 0;
            border-left: 5px solid #1565c0;
        }

        .score-display strong {
            color: #1565c0;
        }

        .explanation-box {
            background: #f0f4ff;
            border-left: 4px solid #667eea;
            padding: 20px;
            margin-top: 15px;
            border-radius: 8px;
            animation: slideIn 0.3s ease;
        }

        .explanation-content h4 {
            color: #667eea;
            margin-bottom: 10px;
            font-size: 1.1em;
        }

        .explanation-content p {
            color: #333;
            line-height: 1.6;
            white-space: pre-wrap;
        }
    </style>
</head>
<body>
    <div class="container">
        <div id="welcome-screen">
            <h1>üè• Clinical Trial Eligibility</h1>
            <p class="subtitle">Find clinical trials that match your profile</p>
            <p style="margin: 20px 0; color: #666; line-height: 1.6;">
                We will ask you a series of questions to determine which clinical trials you may be eligible for. 
                The process is simple: answer Yes or No to each question.
            </p>
            <p style="margin: 20px 0; color: #666;">
                <strong>Total trials to assess: {{ total_trials }}</strong>
            </p>
            <button class="btn-start" onclick="startQuestionnaire()">Start Questionnaire</button>
        </div>

        <div id="questionnaire-screen" class="hidden">
            <div class="progress-bar">
                <div class="progress-fill" id="progress"></div>
            </div>

            <div id="notification-area"></div>

            <div class="trial-info" id="trial-info">
                <h2 id="trial-title">Loading...</h2>
                <p><strong>Trial ID:</strong> <span id="trial-id">-</span></p>
                <p><strong>Progress:</strong> Trial <span id="trial-number">-</span> of <span id="total-trials">-</span></p>
            </div>

            <div class="question-container">
                <span class="question-type" id="question-type">-</span>
                <div class="question" id="question-text">Loading question...</div>
                <div class="button-group">
                    <button class="btn-yes" onclick="submitAnswer(true)">Yes</button>
                    <button class="btn-no" onclick="submitAnswer(false)">No</button>
                </div>
            </div>
        </div>

        <div id="results-screen" class="hidden">
            <h1>üìä Results</h1>
            <p class="subtitle">Your eligibility assessment is complete</p>
            
            <div style="background: #f5f5f5; padding: 20px; border-radius: 10px; margin: 20px 0;">
                <p><strong>Total trials assessed:</strong> <span id="total-assessed">0</span></p>
                <p><strong>Fully eligible trials:</strong> <span id="eligible-count" style="color: #4caf50; font-weight: bold;">0</span></p>
                <p><strong>Partially eligible trials:</strong> <span id="partial-count" style="color: #ff9800; font-weight: bold;">0</span></p>
            </div>

            <div class="results" id="results-list"></div>

            <button class="btn-start" onclick="location.reload()">Start New Assessment</button>
        </div>

        <div id="loading-screen" class="hidden">
            <div class="loading">Loading...</div>
        </div>
    </div>

    <script>
        let currentQuestion = null;
        let currentTrial = null;

        async function startQuestionnaire() {
            document.getElementById('welcome-screen').classList.add('hidden');
            document.getElementById('loading-screen').classList.remove('hidden');

            // Remove this old call:
            // await fetch('/start_questionnaire', { method: 'POST' });
            
            // Directly load the first question:
            await loadNextQuestion();
        }

        async function loadNextQuestion() {
            const response = await fetch('/get_current_trial');
            const data = await response.json();

            document.getElementById('loading-screen').classList.add('hidden');

            if (data.completed) {
                showResults(data.results);
                return;
            }

            currentTrial = data.trial_info;
            currentQuestion = data.current_question;

            document.getElementById('questionnaire-screen').classList.remove('hidden');
            document.getElementById('trial-title').textContent = currentTrial.title;
            document.getElementById('trial-id').textContent = currentTrial.nct_id;
            document.getElementById('trial-number').textContent = currentTrial.trial_number;
            document.getElementById('total-trials').textContent = currentTrial.total_trials;

            document.getElementById('question-text').textContent = currentQuestion.question;
            
            const questionType = document.getElementById('question-type');
            questionType.textContent = currentQuestion.type === 'exclusion' ? '‚õî Exclusion Criteria' : '‚úÖ Inclusion Criteria';
            questionType.className = 'question-type ' + currentQuestion.type;

            updateProgress(currentTrial.trial_number, currentTrial.total_trials);
        }

        async function submitAnswer(answer) {
            document.getElementById('questionnaire-screen').classList.add('hidden');
            document.getElementById('loading-screen').classList.remove('hidden');

            const response = await fetch('/submit_answer', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    question_id: currentQuestion.question_id,
                    answer: answer,
                    nct_id: currentTrial.nct_id,
                    question_type: currentQuestion.type
                })
            });

            const data = await response.json();

            document.getElementById('loading-screen').classList.add('hidden');

            if (data.excluded) {
                showNotification('‚ùå You are excluded from this trial. Moving to the next trial...', 'excluded');
                setTimeout(() => {
                    clearNotification();
                    loadNextQuestion();
                }, 2000);
            } else if (data.trial_completed && data.all_completed) {
                const resultsResponse = await fetch('/get_results');
                const resultsData = await resultsResponse.json();
                showResults(resultsData.results);
            } else if (data.trial_completed && data.move_to_next) {
                const message = `‚úì Trial assessment complete!<br>Match: ${data.inclusion_percentage}% (${data.inclusion_score}/${data.total_inclusion_questions} criteria met)`;
                showNotification(message, 'completed');
                setTimeout(() => {
                    clearNotification();
                    loadNextQuestion();
                }, 2500);
            } else {
                currentQuestion = data.current_question;
                currentTrial = data.trial_info;
                document.getElementById('questionnaire-screen').classList.remove('hidden');
                
                document.getElementById('question-text').textContent = currentQuestion.question;
                
                const questionType = document.getElementById('question-type');
                questionType.textContent = currentQuestion.type === 'exclusion' ? '‚õî Exclusion Criteria' : '‚úÖ Inclusion Criteria';
                questionType.className = 'question-type ' + currentQuestion.type;
            }
        }

        function showNotification(message, type) {
            const notificationArea = document.getElementById('notification-area');
            notificationArea.innerHTML = `<div class="notification ${type}">${message}</div>`;
        }

        function clearNotification() {
            document.getElementById('notification-area').innerHTML = '';
        }

        function updateProgress(current, total) {
            const percentage = (current / total) * 100;
            document.getElementById('progress').style.width = percentage + '%';
        }

        function getPercentageBadgeClass(percentage) {
            if (percentage === 100) return 'percentage-100';
            if (percentage >= 75) return 'percentage-high';
            if (percentage >= 50) return 'percentage-medium';
            return 'percentage-low';
        }

        function showResults(results) {
            document.getElementById('questionnaire-screen').classList.add('hidden');
            document.getElementById('results-screen').classList.remove('hidden');

            const eligibleTrials = results.filter(r => r.eligible);
            const partialTrials = results.filter(r => !r.eligible && r.inclusion_percentage > 0);
            
            document.getElementById('total-assessed').textContent = results.length;
            document.getElementById('eligible-count').textContent = eligibleTrials.length;
            document.getElementById('partial-count').textContent = partialTrials.length;

            const resultsList = document.getElementById('results-list');
            resultsList.innerHTML = '';

            results.forEach((result, index) => {
                const percentage = result.inclusion_percentage || 0;
                const resultClass = result.eligible ? 'eligible' : (percentage > 0 ? 'partial' : 'not-eligible');
                const badgeClass = getPercentageBadgeClass(percentage);
                
                const resultItem = document.createElement('div');
                resultItem.className = `result-item ${resultClass}`;
                resultItem.innerHTML = `
                    <h3>${index + 1}. ${result.nct_id} 
                        <span class="percentage-badge ${badgeClass}">${percentage}% Match</span>
                    </h3>
                    <p><strong>Title:</strong> ${result.title}</p>
                    <p><strong>Status:</strong> ${result.eligible ? '‚úÖ Fully Eligible' : (percentage > 0 ? '‚ö†Ô∏è Partially Eligible' : '‚ùå Not Eligible')}</p>
                    <p><strong>Inclusion Score:</strong> ${result.inclusion_score || 0}/${result.total_inclusion_questions || 0} criteria met</p>
                    <p><strong>Reason:</strong> ${result.reason}</p>
                    <button class="btn-explain" onclick="explainResult('${result.nct_id}')">
                        ü§ñ Explain Results
                    </button>
                    <div id="explanation-${result.nct_id}" class="explanation-box hidden"></div>
                `;
                resultsList.appendChild(resultItem);
            });
        }

        async function explainResult(nctId) {
            const explanationBox = document.getElementById(`explanation-${nctId}`);
            const button = event.target;
            
            // Toggle visibility
            if (!explanationBox.classList.contains('hidden')) {
                explanationBox.classList.add('hidden');
                button.textContent = 'ü§ñ Explain Results';
                return;
            }
            
            // Show loading
            button.disabled = true;
            button.textContent = '‚è≥ Generating explanation...';
            explanationBox.classList.remove('hidden');
            explanationBox.innerHTML = '<div class="loading">Analyzing your responses and ensuring clarity...</div>';
            
            try {
                const response = await fetch('/explain_result', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ nct_id: nctId })
                });
                
                const data = await response.json();
                
                if (data.error) {
                    explanationBox.innerHTML = `<p style="color: #c62828;">‚ùå ${data.error}</p>`;
                } else {
                    // Show quality badge
                    const score = data.quality.comprehension_score;
                    const attempts = data.quality.attempts;
                    const qualityBadge = score >= 80 ? 'üåü Excellent' : 
                                        score >= 60 ? '‚úÖ Good' : 
                                        '‚ö†Ô∏è Fair';
                    
                    let qualityInfo = `
                        <div style="background: #e3f2fd; padding: 8px; border-radius: 5px; margin-bottom: 10px; font-size: 0.85em;">
                            <strong>Quality:</strong> ${qualityBadge} (${score}/100)
                            ${attempts > 1 ? ` | Improved after ${attempts} attempts` : ''}
                        </div>
                    `;
                    
                    if (data.warning) {
                        qualityInfo += `
                            <div style="background: #fff3e0; padding: 8px; border-radius: 5px; margin-bottom: 10px; font-size: 0.85em; color: #e65100;">
                                ‚ö†Ô∏è ${data.warning}
                            </div>
                        `;
                    }
                    
                    explanationBox.innerHTML = `
                        ${qualityInfo}
                        <div class="explanation-content">
                            <h4>üìã Explanation</h4>
                            <p>${data.explanation}</p>
                        </div>
                    `;
                }
                
                button.textContent = 'ü§ñ Hide Explanation';
            } catch (error) {
                explanationBox.innerHTML = `<p style="color: #c62828;">‚ùå Error generating explanation: ${error.message}</p>`;
                button.textContent = 'ü§ñ Explain Results';
            } finally {
                button.disabled = false;
            }
        }
    </script>
</body>
</html>